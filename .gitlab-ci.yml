.test:
  stage: test
  image: debian:${RELEASE}
  before_script:
  - echo Etc/UTC > /etc/timezone
  - echo 'APT::Install-Recommends "0";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Install-Suggests "0";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Acquire::Retries "20";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Acquire::https::Verify-Peer "false";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Acquire::https::Verify-Host "false";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Dpkg::Use-Pty "0";' >> /etc/apt/apt.conf.d/99gitlab
  - apt-get update || true
  - apt-get install -y procps proxychains python3 python3-pytest python3-coverage python3-pytest-cov python3-gnupg python3-bcrypt python3-requests python3-aiohttp python3-openssl python3-pip python3-pyotp
  - sysctl -w net.ipv6.conf.all.disable_ipv6=0
  - sysctl -w net.ipv6.conf.default.disable_ipv6=0
  # FIXME: would be nice to resolve proxy.plabs.ch instead of hardcoding one value, or even better to parse http_proxy
  - echo -e "[ProxyList]\nhttp 172.20.0.127 3128\n" > /etc/proxychains.conf
  - apt-get update
  - apt-get install -y pkg-config libgirepository1.0-dev libcairo2-dev
  - apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 python3-dev
  - apt-get install -y libpython3-dev libdbus-1-dev
  - pip3 install --user --upgrade pip
  - pip3 install --user --upgrade setuptools
  - apt-get install -y --no-install-recommends git
  - git clone --branch dev-mickael https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.protontech.ch/ProtonVPN/linuxrefactored/python-proton-core.git
  - cd python-proton-core && pip3 install -r requirements.txt && pip3 install --user . && cd ..
  - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.protontech.ch/ProtonVPN/linux/new-client/python-protonvpn-connection.git
  - cd python-protonvpn-connection && pip3 install -r requirements.txt && pip3 install --user . && cd ..
  script:
  # We need to install it otherwise entry points are not accessible by testsuite
  # FIXME: we need to fill loader with static data to make sure our test is reproductible
  # then we won't need that
  - pip3 install --user -r requirements.txt
  - pip3 install --user --editable .
  - proxychains python3 -m pytest --cov=protonvpn_api_core --junitxml=report.xml tests/
  - python3-coverage xml -o cov.xml
  artifacts:
    reports:
      cobertura: cov.xml
      junit: report.xml

bandit-sast:
  stage: test
  when: manual
  image: debian:${RELEASE}
  before_script:
  - echo Etc/UTC > /etc/timezone
  - echo 'APT::Install-Recommends "0";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Install-Suggests "0";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Acquire::Retries "20";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Acquire::https::Verify-Peer "false";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Acquire::https::Verify-Host "false";' >> /etc/apt/apt.conf.d/99gitlab
  - echo 'Dpkg::Use-Pty "0";' >> /etc/apt/apt.conf.d/99gitlab
  - apt-get update || true
  - apt-get install -y python3 python3-bandit
  - apt-get install -y procps
  - sysctl -w net.ipv6.conf.all.disable_ipv6=0
  - sysctl -w net.ipv6.conf.default.disable_ipv6=0
  script:
  # testing the logger require to change environment variable BEFORE the module is loaded => dedicated call
  - bandit proton -r --format xml -o bandit.xml
  artifacts:
    reports:
      junit: bandit.xml

pages:
  image: python:3.10.0-slim-bullseye
  when: manual
  script:
  - pip install -r requirements.txt
  - pip install sphinx sphinx-rtd-theme
  - pip install .
  - sphinx-build -b html docs/ public
  artifacts:
    paths:
    - public
  only:
  - master

test-buster:
  extends: .test
  variables:
    RELEASE: 'buster'

#test-bullseye:
#  extends: .test
#  variables:
#    RELEASE: 'bullseye'
